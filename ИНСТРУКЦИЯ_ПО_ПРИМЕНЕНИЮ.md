# Инструкция по применению изменений для ограничения бронирования

## Проблема

Ранее клиенты могли бронировать туры за любого другого клиента, что является нарушением безопасности.

## Решение

Добавлена связь между таблицами `users` и `clients` через поле `user_id`, что позволяет ограничить бронирование только для самого пользователя.

## Шаги для применения изменений

### 1. Выполните миграцию базы данных

Запустите SQL скрипт `migration_add_user_id_to_clients.sql` в вашей PostgreSQL базе данных:

```sql
-- Добавляем поле user_id в таблицу clients
ALTER TABLE public.clients ADD COLUMN user_id INTEGER;

-- Добавляем внешний ключ на таблицу users
ALTER TABLE public.clients
ADD CONSTRAINT clients_user_id_fkey
FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;

-- Добавляем индекс для быстрого поиска
CREATE INDEX idx_clients_user_id ON public.clients(user_id);
```

### 2. Обновите существующие данные (ВАЖНО!)

Для существующих клиентов нужно вручную связать их с пользователями. Выполните запросы вида:

```sql
-- Пример для каждого существующего клиента:
UPDATE public.clients
SET user_id = (SELECT id FROM public.users WHERE username = 'имя_пользователя')
WHERE id = клиент_id;
```

### 3. Перекомпилируйте приложение

Выполните команду:

```bash
./gradlew build
```

## Что изменилось

### Для клиентов:

- ✅ Клиенты видят только свои данные в списке клиентов
- ✅ Поле выбора клиента скрыто (они могут бронировать только за себя)
- ✅ Добавлена дополнительная проверка безопасности
- ✅ Упрощен интерфейс бронирования

### Для администраторов:

- ✅ Администраторы по-прежнему видят всех клиентов
- ✅ Могут бронировать туры за любого клиента
- ✅ Интерфейс не изменился

### Процесс регистрации:

- ✅ Новые клиенты автоматически связываются с пользователями
- ✅ При регистрации клиента создается запись в обеих таблицах

## Проверка работы

1. Зарегистрируйте нового клиента
2. Войдите под этим клиентом
3. Перейдите на вкладку "Сделать бронирование"
4. Убедитесь, что:
   - Поле выбора клиента скрыто
   - Можно выбрать только туры
   - Бронирование создается успешно

## Безопасность

Теперь система гарантирует, что:

- Клиенты могут бронировать туры только для себя
- Невозможно забронировать тур за другого клиента
- Администраторы сохраняют полный доступ ко всем функциям

