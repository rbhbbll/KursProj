# Резюме изменений в Java-коде

## Обновленные файлы

### 1. DatabaseManager.java

```java
// Новый метод регистрации клиента с использованием обновленной процедуры
public void registerClient(String fullName, String phone, String email, String passport, java.sql.Date birthDate, int userId) throws SQLException {
    String sql = "CALL public.register_new_client(?, ?, ?, ?, ?, ?)";
    try (Connection conn = getConnection();
         CallableStatement stmt = conn.prepareCall(sql)) {
        stmt.setString(1, fullName);
        stmt.setString(2, phone);
        stmt.setString(3, email);
        stmt.setString(4, passport);
        stmt.setDate(5, birthDate);
        stmt.setInt(6, userId);
        stmt.execute();
    }
}

// Новый метод бронирования с проверкой прав
public void makeBooking(int clientId, int tourId, int userId, String userRole) throws SQLException {
    String sql = "CALL public.make_booking(?, ?, ?, ?)";
    try (Connection conn = getConnection();
         CallableStatement stmt = conn.prepareCall(sql)) {
        stmt.setInt(1, clientId);
        stmt.setInt(2, tourId);
        stmt.setInt(3, userId);
        stmt.setString(4, userRole);
        stmt.execute();
    }
}
```

### 2. BookingWindow.java

```java
// Обновленный метод бронирования с обработкой ошибок прав доступа
try {
    dbManager.makeBooking(clientId, tourId, user.getId(), user.getRole());
} catch (SQLException e) {
    if (e.getMessage().contains("Недостаточно прав") || e.getMessage().contains("can_user_book_for_client")) {
        JOptionPane.showMessageDialog(this,
            "У вас нет прав для этой операции! Клиенты могут бронировать туры только для себя.",
            "Ошибка доступа",
            JOptionPane.ERROR_MESSAGE);
        return;
    } else {
        throw e;
    }
}
```

## Ключевые изменения

1. **Процедура регистрации**: Теперь принимает `user_id` для связи клиента с пользователем
2. **Процедура бронирования**: Принимает `user_id` и `user_role` для проверки прав
3. **Проверка прав**: Перенесена на уровень базы данных
4. **Обработка ошибок**: Добавлена обработка ошибок недостаточных прав

## Результат

- ✅ Клиенты могут бронировать туры только для себя
- ✅ Администраторы сохраняют полный доступ
- ✅ Безопасность обеспечивается на уровне БД
- ✅ Код упрощен и более надежен

