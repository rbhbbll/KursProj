# Решение проблемы "клиент не найден"

## Проблема

При входе в систему под клиентом появляется ошибка "Клиентская запись не найдена. Обратитесь к администратору", и клиент не может забронировать тур.

## Причина

Существующие пользователи в базе данных не имеют связи с клиентами (поле `user_id` в таблице `clients` не заполнено).

## Решение

### Вариант 1: Исправление данных в базе (Рекомендуемый)

1. **Выполните SQL скрипт** `fix_existing_users_clients.sql` в вашей базе данных:

```sql
-- Посмотрите на существующих пользователей и клиентов
SELECT 'Пользователи:' as info;
SELECT id, username, role FROM public.users ORDER BY id;

SELECT 'Клиенты:' as info;
SELECT id, full_name, user_id FROM public.clients ORDER BY id;
```

2. **Свяжите клиентов с пользователями** (замените на ваши реальные данные):

```sql
-- Примеры (замените на ваши данные):
UPDATE public.clients SET user_id = (SELECT id FROM public.users WHERE username = 'admin') WHERE id = 1;
UPDATE public.clients SET user_id = (SELECT id FROM public.users WHERE username = '123') WHERE id = 3;
UPDATE public.clients SET user_id = (SELECT id FROM public.users WHERE username = 'кирилл') WHERE id = 4;
-- ... и так далее для всех клиентов
```

3. **Проверьте результат**:

```sql
SELECT c.id, c.full_name, c.user_id, u.username, u.role
FROM public.clients c
LEFT JOIN public.users u ON c.user_id = u.id
ORDER BY c.id;
```

### Вариант 2: Автоматическое создание клиентов (Временное решение)

Код уже обновлен и теперь автоматически создает клиентскую запись, если она не найдена. При следующем входе в систему:

1. Если клиент не найден, система автоматически создаст запись
2. Клиент сможет бронировать туры
3. В консоли будут отображаться отладочные сообщения

## Что изменилось в коде

### DatabaseManager.java

- ✅ Добавлены отладочные сообщения в `getClientIdByUserId()`

### BookingWindow.java

- ✅ Добавлены отладочные сообщения
- ✅ Добавлен метод `createClientForUser()` для автоматического создания клиентов
- ✅ Улучшены сообщения об ошибках с отладочной информацией

## Проверка работы

1. **Перекомпилируйте приложение**:

   ```bash
   ./gradlew build
   ```

2. **Запустите приложение**:

   ```bash
   ./gradlew run
   ```

3. **Войдите под клиентом** и проверьте:
   - В консоли должны появиться отладочные сообщения
   - Если клиент не найден, он будет создан автоматически
   - Клиент сможет забронировать тур

## Отладочная информация

В консоли будут отображаться сообщения вида:

```
DEBUG: Ищем клиента для пользователя с ID 5 и ролью client
DEBUG: Клиент не найден для пользователя 5
DEBUG: Создан новый клиент с ID 22
```

## Рекомендации

1. **Используйте Вариант 1** для правильного исправления данных
2. **Вариант 2** - временное решение для быстрого восстановления работы
3. После исправления данных можно убрать отладочные сообщения из кода

## Дополнительные проверки

Если проблема сохраняется, проверьте:

1. **Структуру таблицы**:

   ```sql
   \d public.clients
   ```

2. **Ограничения**:

   ```sql
   SELECT * FROM information_schema.table_constraints
   WHERE table_name = 'clients';
   ```

3. **Права доступа**:
   ```sql
   GRANT ALL PRIVILEGES ON public.clients TO alex;
   ```
